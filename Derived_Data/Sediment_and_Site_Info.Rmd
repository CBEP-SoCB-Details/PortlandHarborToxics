---
title: "Extracting Sediement and Site info for Portland Harbor Sediment Tocicity Survey "
output: html_notebook
---

# Install Libraries
```{r}
library(readxl)
library(tidyverse)
```

# Set Graphic Defaults
This code block calls a script that establishes defaults for a consistent Casco Bay State of the Bay graphics look and feel.  It establishes cbep_colors, cbep_colors2, and theme_cbep, after loading selected fonts.  IF you do not run this code, you will need to define those names somewhere else, or remove references to them in the remainder of the code.
```{r}
sibfldnm <- 'Graphics'
parent <- dirname(getwd())
sibling <- paste(parent,sibfldnm, sep = '/')
fn <- 'CBEPGraphicsSetup.R'

source(paste(sibling,fn, sep = '/'))
rm(sibfldnm, parent, sibling, fn)
```

#Generate list of sites and site abbreviations
Given the structure of the data, it is easier to just enter these data by hand, rather than try to read them from Excel.
Once I get lats and longs, those data should be added here as well.

Note that 'CSS-13' and 'CSS-15' are correct, at least for sediment-related data in the main data column.  That appears to be an inconsistency in the original site naming.
```{r}
	sitename <-  c("East End Beach", "Amethyst Lot", "Maine State Pier/Ocean Gateway", "Maine Wharf", "Portland Pier",
                "Chandler's Wharf", "Union Wharf", "Union Wharf", "Wright Wharf", "Holyoke Wharf",
                "Deake's Wharf", "Portland Yacht Services", "Ricker's Wharf", "South Port Marina", "Aspasia/Sunset Marina",
                "Port Harbor/ Breakwater Marina")
  sitecode <- c('CSP-1', 'CSP-2', 'CSP-3', 'CSP-4', 'CSP-5', 'CSP-6', 'CSP-7', 'CSP-7D', 'CSP-8', 'CSP-9', 'CSP-10', 'CSP-11', 'CSP-12', 'CSS-13', 'CSP-14', 'CSS-15')

site.info <- tibble(sitecode,sitename)
head(site.info)
rm(sitecode, sitename)
```

Unfortunately, direct lookup of names from the sediment characteristics table in the draft Excel spreadsheet generates a few names for sediment parameters that do not appear in the  data table -- perhaps because no one thought anyone would be doing this kind of crazy lookup process just to generate a list of parameters. So, we generate this by hand too.
```{r}
sed.names <- c('% COARSE SAND', '% FINE SAND', '% MEDIUM SAND',
                'FINES', 'GRAVEL', 'MOISTURE', 'SOLIDS, TOTAL',
                'TOTAL ORGANIC CARBON (REP1)', 'TOTAL ORGANIC CARBON (REP2)')
```

# Load the Main Data
```{r}
sibfldnm <- 'Derived Data'
parent <- dirname(getwd())
sibling <- paste(parent,sibfldnm, sep = '/')
fn <- "working.data.xls"

the.data <- read_excel(paste(sibling,fn, sep='/'), 
    sheet = "Combined", col_types = c("skip", 
        "text", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", 
        "skip", "text", "numeric", "text", 
        "numeric", "text", "numeric", "numeric", 
        "text", "text", "text", "skip", 
        "skip", "skip", "skip", "skip", 
        "numeric", "numeric", "skip", "skip", 
        "skip", "skip", "skip", "skip", 
        "skip"))
View(the.data)
```

# Extract Site Sediment Characteristics
This is an example of the way we can filter down to selected parameters defined in a list of parameters.  Notice the second and third filters, which exclude  some QA/QC samples.  Note also that we have some duplicate samples (for CSP-6, CSP-15 - all measurements - CSP-10 - TOC data only - and CSP-9 - all observations EXCEPT TOC), so we will need to calculate average values across multiple samples. Finally, we "spread" the values into separate data columns, calcualte average TOC values, and a total sand value.

# Sediment data preparation
```{r}
sed.data <- the.data %>%
  filter (the.data$PARAMETER_NAME %in% sed.names) %>%
  filter(is.na(`%_RECOVERY`)) %>%
  filter(SAMPLE_ID != 'QC') %>%
  group_by(SAMPLE_ID, PARAMETER_NAME) %>%
  summarize(CONCENTRATION = mean(CONCENTRATION, na.rm=TRUE)) %>%
  spread(key = PARAMETER_NAME, value = CONCENTRATION) %>%
  rowwise() %>%
  mutate(TOC = mean(c(`TOTAL ORGANIC CARBON (REP1)`, `TOTAL ORGANIC CARBON (REP2)`))) %>%
  mutate(AllSand = sum(c(`% COARSE SAND`, `% FINE SAND`, `% MEDIUM SAND`))) %>%
  select (-c(`TOTAL ORGANIC CARBON (REP1)`, `TOTAL ORGANIC CARBON (REP2)`))
summary(sed.data)

```

# And send those back into the site info
This is an arguable step, since we could keep the data separate, but it appears to me that the way we will use the sediment characteristics is to help us interpret other data, so it makes sense to associate it with the site names.
```{r}
site.info <- site.info %>%
  left_join(sed.data, by = c('sitecode'='SAMPLE_ID')) %>%
  mutate(sitecode = factor(sitecode, levels =  site.info$sitecode))
summary(site.info)
```
# Cleanup
```{r}
rm(sed.names, sed.data)
```


# Preliminary Interpretation
```{r}
cor(site.info[,3:11], use = 'pairwise')
```
Correlations are ofte nquite high, which is expected. Note that coarse sand is positively correlated wit hgravel, but negatively correlated with fine sand and fines.  High energy versus low energy sites? Also, sum of oll sands s negatively correlated with fines.  Total organic carbon has moderate correlation with sand and gravel.  That strikes me as odd.
```{r}
plt <- ggplot(site.info, aes(sitecode, FINES)) + geom_col()
plt
```

```{r}
plt <- ggplot(site.info, aes(sitecode, AllSand)) + geom_col()
plt
```

```{r}
plt <- ggplot(site.info, aes(sitecode, TOC)) + geom_col()
plt
```


```{r}
plt <- ggplot(site.info, aes(AllSand, FINES)) + geom_point() + geom_smooth(method = 'lm')
plt
```
In contrast, TOC is not closely correlated with either fines or total sands.  The strongest correlations are wit hmoisture and total solids.  
```{r}
plt <- ggplot(site.info, aes(FINES, TOC)) + geom_point() + geom_smooth(method = 'lm')
plt
```
