---
title: "Producing Graphics For Portland Sediment Toxicity Data"
output: html_notebook
---

# Install Libraries
```{r}
library(readxl)
library(tidyverse)
library(ggthemes)
library(GGally)
library(maxLik)
```

# Source Functions for Non-detects
These functions provide a way to generate maximum likelihood estimates of unobserved values from samples that fell below detection limits.
```{r}
sibfldnm <- 'Analysis'
parent <- dirname(getwd())
sibling <- paste(parent,sibfldnm, sep = '/')
fn <- 'LNConditionalMeans.R'

source(paste(sibling,fn, sep='/'))
```

# Create Site Data
```{r}
sitename <-  c("East End Beach", "Amethyst Lot",
               "Maine State Pier/Ocean Gateway", "Maine Wharf",
               "Portland Pier", "Chandler's Wharf",
               "Union Wharf", "Union Wharf", "Wright Wharf",
               "Holyoke Wharf", "Deake's Wharf",
               "Portland Yacht Services", "Ricker's Wharf",
               "South Port Marina", "Aspasia/Sunset Marina",
               "Port Harbor/ Breakwater Marina")
SAMPLE_ID <- c('CSP-1', 'CSP-2', 'CSP-3', 'CSP-4', 'CSP-5',
                'CSP-6', 'CSP-7', 'CSP-7D', 'CSP-8', 'CSP-9',
                'CSP-10', 'CSP-11', 'CSP-12', 'CSS-13', 'CSP-14',
                'CSS-15')

site.info <- tibble(SAMPLE_ID,sitename)
head(site.info)
rm(SAMPLE_ID, sitename)
```

up process just to generate a list of parameters. So, we generate this by hand.
# Lists of Names of Parameters
```{r}
sibfldnm <- 'Derived Data'
parent <- dirname(getwd())
sibling <- paste(parent,sibfldnm, sep = '/')
fn <- 'working.data.xls'

sed_names <- c('% COARSE SAND', '% FINE SAND', '% MEDIUM SAND',
                'FINES', 'GRAVEL', 'MOISTURE', 'SOLIDS, TOTAL',
                'TOTAL ORGANIC CARBON (REP1)', 'TOTAL ORGANIC CARBON (REP2)')

metal_names <- read_excel(paste(sibling,fn, sep='/'),
                           sheet = "Metals", skip = 3) %>%
  select(1) %>%
  slice(1:8) %>%
  mutate(PARAMETER_NAME = substr(PARAMETER_NAME, 1, nchar(PARAMETER_NAME)-7))
metal_names <- metal_names$PARAMETER_NAME

pah_names <- read_excel(paste(sibling,fn, sep='/'),
                        sheet = "PAHs", skip = 3) %>%
  select(1) %>%
  slice(1:16)
pah_names <- pah_names$PARAMETER_NAME

pcb_names <- read_excel(paste(sibling,fn, sep='/'),
                        sheet = "PCBs", skip = 3) %>%
  select(1) %>%
  slice(1:22) #%>%
pcb_names <- pcb_names$PARAMETER_NAME

pesticide_names <- read_excel(paste(sibling,fn, sep='/'),
                               sheet = "Pesticides", skip = 3) %>%
  select(1) %>%
  slice(1:8)
pesticide_names <- pesticide_names$PARAMETER_NAME

(parmnames = c(sed_names, metal_names, pah_names, pcb_names, pesticide_names))

```

# Load Basic Data
```{r}
sibfldnm <- 'Derived Data'
parent <- dirname(getwd())
sibling <- paste(parent,sibfldnm, sep = '/')
fn <- 'working.data.xls'

the.data <- read_excel(paste(sibling,fn, sep='/'), 
    sheet = "Combined", col_types = c("skip", 
        "text", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", 
        "text", "text", "numeric", "text", 
        "numeric", "text", "numeric", "numeric", 
        "text", "text", "text", "skip", 
        "skip", "skip", "skip", "skip", 
        "numeric", "numeric", "skip", "skip", 
        "skip", "skip", "skip", "skip", 
        "skip")) %>%
  mutate(SAMPLE_ID = factor(SAMPLE_ID, levels = c("CSP-1", "CSP-2", "CSP-3",
                                                  "CSP-4", "CSP-5", "CSP-6",
                                                  "CSP-7", "CSP-7D", "CSP-8",
                                                  "CSP-9", "CSP-10", "CSP-11",
                                                  "CSP-12", "CSS-13", "CSP-14",
                                                  "CSS-15"))) %>%
  # Remove ', TOTAL' from the end of the names of metals
  mutate(PARAMETER_NAME = 
           ifelse(substr(PARAMETER_NAME, nchar(PARAMETER_NAME)-6,
                          nchar(PARAMETER_NAME)) == ', TOTAL',
                  substr(PARAMETER_NAME, 1, nchar(PARAMETER_NAME)-7),
                  PARAMETER_NAME))
```

# Assemble Simplified Data
We filter data to eliminate QA/QC samples, then combine Reporting Limits and Observed Concentrations into data on concentrations and a flag indicating which are censored values.
```{r}
sed_data_long <- the.data %>% 
  filter (the.data$PARAMETER_NAME %in% parmnames) %>%
  filter(is.na(`%_RECOVERY`)) %>%
  filter(SAMPLE_ID != 'QC') %>%
  mutate(CONCENTRATION = ifelse(is.na(CONCENTRATION) & LAB_QUALIFIER %in% c('U', 'J'),
                                REPORTING_LIMIT, CONCENTRATION)) %>%
  group_by(SAMPLE_ID, PARAMETER_NAME) %>%
  summarize(CONCENTRATION = mean(CONCENTRATION, na.rm=TRUE),
            samples = n(),
            censored = sum(LAB_QUALIFIER=='U', na.rm=TRUE)) %>%
  ungroup() %>%
  rename(Contaminant = PARAMETER_NAME) %>%
  mutate(Contaminant = factor(Contaminant)) %>%
  
  #Create group variable to facilitate subsetting.
  mutate(cgroup = ifelse(Contaminant %in% sed_names,1,
                   ifelse(Contaminant %in% metal_names,2,
                      ifelse(Contaminant %in% pah_names,3,
                          ifelse(Contaminant %in% pcb_names,4,
                              ifelse(Contaminant %in% pesticide_names,
                                     5,0)))))) %>%
  mutate(cgroup = factor(cgroup, labels = c('Sediment', 'Metals', 'PAHs',
                                         'PCBs', 'Pesticides')))  %>% 
  mutate(Contaminant = fct_reorder(Contaminant, as.numeric(Contaminant))) %>%
  mutate(Contaminant = fct_reorder(Contaminant, as.numeric(cgroup)))

levels(sed_data_long$Contaminant)
```
## A Check for Half Censored Observations
Since in a few cases, we averaged two samples together, it is possible that we have averaged a non-detect with a detection.  It turns out we did, but just once.
```{r}
sum(sed_data_long$censored> 0 & sed_data_long$censored<sed_data_long$samples)

sed_data_long[which(sed_data_long$censored> 0 & sed_data_long$censored<sed_data_long$samples),]

the.data[the.data$SAMPLE_ID=='CSS-15' & the.data$PARAMETER_NAME=="4,4'-DDT",]
```
Note that these two DDT results were flagged as problematic because differences between the two observations were greater than an acceptable relative percent difference. That does not engender great confidence in the data....

We have to pick this up again later, when we calculate values for Pesticide Totals.

# Strategy
Overall, we want a visually simple graphic that captures the most important aspects of contamination in Portland harbor.  From other analyses, we know that 
1.  Metals levels are consistently below screening levels
2. Most pesticide residues were never or almost never detected, the only exceptions being the DDT residues.
3.  Other contaminants exceed screening levels at about half of sampling locations.
4. Levels of contaminants are highly correlated

Multiple contaminants with complicated names can make for intimidating graphic.  We need to identify ways to simplify the data display without distorting the meaning.  Screening levels are available for Total PAHs, Total PCBs, and sum of DDT residues, suggesting we can focus on those three aggregate indicators of contamination and simplify data presentation.  There is no equivalent way of simplifying display of the metals data, but all metals are below levels of concern.

The data is complicated by the presence of many non-detects.  Her we develop estimates of "real" values in three ways:
1. Treating each non-detect as having been observed at the reporting limit (which clearly overstates actual levels, and confounds observation with analytic concerns).
2. Treating each non-detect as half the observed level.  While this is logically better than assuming that each non-detect was present at the detection limit, it has no basis in statistical theory, and is essentially arbitrary
3. Using lognormal maximum likelihood estimation to estimate conditional expected value of observations, given only that they fell below a detection limit.

Here we consider both and 'J' flags to be "non-detects' as both are below the reporting limits.  A more sophisticated analysis, with more data might model 'J' and 'U' flags differently, but here we combine them.

Details on the methods are described in the R Notebook "Conditional Means of Censored Distributions"

## Special Considerations
1.  Reporting limits for organic contaminants from sample CSP-8 were exceptionally high.  For PCBs the reporting limit was sufficiently high to bias any approach to estimating PCB loads, so we delete this point from consideration
2. DDT concentrations from Sample CSS-15 were replicates that failed a QA/QC check.  One was a non-detect, while the other was roughly double the reporting limit.  Here we report results based on averaging imputed values of the non-detect with the observed value from the other sample.

# Metals Data
No reorganization needed. All metals are below levels of concern, and there are no suitable aggregate screening levels for metals or sum of metals.  So there is little point in reporting specific values, and no easy way to summarize results. We could show one or two metals of  interest -- like Mercury -- or just report that all are below levels of concern.

# PAH Data
```{r}
pah_res<- sed_data_long %>%
  filter (cgroup =='PAHs') %>%

  mutate(censored = censored>0) %>%

  group_by(Contaminant) %>%
  mutate(LikCensored = LNConditionalMeans(CONCENTRATION, censored)) %>%
  ungroup()  %>%
  mutate(HalfDL = ifelse(censored, CONCENTRATION/2, CONCENTRATION)) %>%
  group_by(SAMPLE_ID) %>%
  summarize(LNtotPAH = sum(LikCensored),
            halfDLtotPAH = sum(HalfDL),
            totPAH = sum(CONCENTRATION))
```
# PCB Data
```{r}
pcb_res<- sed_data_long %>%
  filter (cgroup =='PCBs') %>%
  
  # CSP-8 had exceptionally high PCB detection limits
  filter(SAMPLE_ID != 'CSP-8') %>% 
  
  mutate(censored = censored>0) %>%

  group_by(Contaminant) %>%
  mutate(LikCensored = LNConditionalMeans(CONCENTRATION, censored)) %>%
  ungroup()  %>%
  mutate(HalfDL = ifelse(censored, CONCENTRATION/2, CONCENTRATION)) %>%
  group_by(SAMPLE_ID) %>%
  summarize(LNtotPCB = sum(LikCensored),
            halfDLtotPCB = sum(HalfDL),
            totPCB = sum(CONCENTRATION))
```

# Pesticides Data
We want to report Total DDT Residues.  Other pesticides were observed too rarely to be worth reporting on.
## Correcting for Half non-detect
When we average across the two values, we are averaging a non-detect with a significantly higher observation.  This only happened once in these data, in the DDT results for Sample CSS-15.

To be accurate, we need to calculate estimates of the censored values (ND, Half ND and Maximum Likelihood) on the original raw data and average the results, rather than calculate estimates based on an average of an observation and a reporting limit.

Obviously,if we are looking at the full detection limit, the average of a sum is the sum of the averages, and it makes no difference, but it should matter for the other two estimators, especially for the maximum likelihood estimator.
### Calculate average using half DL limit
```{r}
tmp <- the.data %>%
  filter(PARAMETER_NAME=="4,4'-DDT") %>%
  filter(SAMPLE_ID == 'CSS-15') %>%
  filter(is.na(`%_RECOVERY`)) %>%
  filter(SAMPLE_ID != 'QC') %>%
  mutate(censored = LAB_QUALIFIER %in% c('U', 'J')) %>%
  mutate(CONCENTRATION = ifelse(censored, REPORTING_LIMIT, CONCENTRATION)) %>%
  select(censored, CONCENTRATION, REPORTING_LIMIT) %>%
  mutate(halfdl = ifelse(censored, REPORTING_LIMIT/2, CONCENTRATION))
(hdl <- mean(tmp%>%pull(halfdl)))
```
### Calculate Average by Maximum Likelihood Estimator
```{r}
est <- the.data %>%
  filter(PARAMETER_NAME=="4,4'-DDT") %>%
  filter(is.na(`%_RECOVERY`)) %>%
  filter(SAMPLE_ID != 'QC') %>%
  select(SAMPLE_ID, CONCENTRATION, REPORTING_LIMIT, LAB_QUALIFIER) %>%
  mutate(censored = LAB_QUALIFIER %in% c('U', 'J')) %>%
  mutate(CONCENTRATION = ifelse(censored, REPORTING_LIMIT, CONCENTRATION)) %>%
  mutate(lnest = LNConditionalMeans(CONCENTRATION, censored)) %>%
  filter(SAMPLE_ID == 'CSS-15') %>%
  pull(lnest)
(mle <- mean(est))
rm(tmp, est)
```
## Assemble Pesticides Data
```{r}
pests_data_long <- sed_data_long %>%
  filter (cgroup =='Pesticides') %>%
  mutate(censored = censored>0) %>%
  group_by(Contaminant) %>%
  mutate(LikCensored = LNConditionalMeans(CONCENTRATION, censored)) %>%
  ungroup()  %>%
  mutate(HalfDL = ifelse(censored, CONCENTRATION/2, CONCENTRATION))
```
### Correct DDT Value.
```{r}
pests_data_long <- pests_data_long %>%
  mutate(LikCensored = ifelse(SAMPLE_ID =='CSS-15' & Contaminant =="4,4'-DDT",
                              mle, LikCensored)) %>%
  mutate(HalfDL = ifelse(SAMPLE_ID=='CSS-15' & Contaminant == "4,4'-DDT",
                         hdl, HalfDL))
rm(mle, hdl)
```
### Assemble Final DDT Residue Data
```{r}
pesticide_res <- pests_data_long %>%
  group_by(SAMPLE_ID) %>%
  summarize(LNtotDDT = sum(LikCensored),
            halfDLtotDDT = sum(HalfDL),
            totDDT = sum(CONCENTRATION))
```

# Assemble Final Results
```{r}
res <- site.info %>%
  left_join(pah_res) %>%
  left_join(pcb_res) %>%
  left_join(pesticide_res)
```

```{r}
res_long_MLE <- res %>%
  select(SAMPLE_ID, sitename, starts_with('LNtot')) %>%
  rename_at(3:5, ~substr(.,nchar(.)-2, nchar(.))) %>%
  gather(key = 'Contaminant', value = 'MLE', -SAMPLE_ID, -sitename)

res_long_RL <- res %>%
  select(SAMPLE_ID, sitename, starts_with('tot')) %>%
  rename_at(3:5, ~substr(.,nchar(.)-2, nchar(.))) %>%
  gather(key = 'Contaminant', value = 'RL', -SAMPLE_ID, -sitename)

res_long_HRL <- res %>% 
  select(SAMPLE_ID, sitename, starts_with('half')) %>%
  rename_at(3:5, ~substr(.,nchar(.)-2, nchar(.))) %>%
  gather(key = 'Contaminant', value = 'HRL', -SAMPLE_ID, -sitename)

res <- res_long_MLE %>% left_join(res_long_HRL) %>% left_join(res_long_RL) %>%
  mutate(Contaminant = factor(Contaminant, levels = c('DDT', 'PAH', 'PCB'),
                              labels = c('DDT Residues', 'Total PAHs', 'Total PCBs')))

rm(res_long_MLE, res_long_HRL, res_long_RL)
```

# Cleanup
```{r}
rm(parmnames, sed_names, metal_names, pah_names, pah_res, pcb_names, pcb_res,
   pesticide_names, pesticide_res, pests_data_long)
rm(the.data, sed_data_long, site.info)
```

# Screening Levels
```{r}
pcb <- c(22.7, 180)
pah <- c(4022, 44792)
ddt <- c(1.58, 46.1)

sl <- tibble(Contaminant = rep(c('DDT Residues', 
                                 'Total PAHs', 'Total PCBs'), each = 2),    
             Threshold = rep(c('ERL','ERM'),3),
             Value = c(ddt,pah, pcb))
```

## Generate SCreening Levels Flags
```{r}
erl <- sl %>% filter(Threshold == 'ERL') %>% select(-Threshold)
erm <- sl %>% filter(Threshold == 'ERM') %>% select(-Threshold)
res_screen <- res %>%
  select(SAMPLE_ID, sitename, Contaminant, MLE) %>%
  filter( ! is.na(MLE)) %>%
  mutate(ERL = erl$Value[match(Contaminant, erl$Contaminant)]) %>%
  mutate(ERM = erm$Value[match(Contaminant, erm$Contaminant)]) %>%
  mutate(SL = ifelse(MLE<ERL, 'Below ERL',
                     ifelse(MLE<ERM, 'Between ERL and ERM', 'Above ERM'))) %>%
  mutate(SL = factor(SL, levels = c('Below ERL',
                                     'Between ERL and ERM',
                                     'Above ERM'))) %>%
  select(-ERM, -ERL)
```
## A Wide Version for Export to GIS
```{r}
a <- res_screen %>%
  pivot_wider(names_from = Contaminant, values_from = MLE,
              id_cols = c(SAMPLE_ID, sitename)) %>%
  rename_at(c(3,4), ~substr(., nchar(.)-3, nchar(.))) %>%
  rename(DDTs = `DDT Residues`)

b <- res_screen %>%
  pivot_wider(names_from = Contaminant, values_from = SL, 
              id_cols = c(SAMPLE_ID, sitename)) %>%
  rename_at(c(3,4), ~substr(., nchar(.)-3, nchar(.))) %>%
  rename(DDTs = `DDT Residues`) %>%
  rename_at(3:5, ~paste0(., 'SL'))

res_screen_wide <- a %>% left_join(b)

rm(a,b)

write.csv(res_screen_wide,'MLE Results.csv')
```


# Set Graphic Defaults
This code block calls a script that establishes defaults for a consistent Casco Bay State of the Bay graphics look and feel.  It establishes cbep_colors, cbep_colors2, and theme_cbep, after loading selected fonts.  It then sets theme_cbep() as the default theme.

If you do not run this code, you will need to define the CBEP color names somewhere else, or remove references to them in the code.
```{r}
fn <- 'CBEPGraphicsSetup.R'
source(fn)
rm(fn)
```




# Graphic
```{r fig.width = 5, fig.height=5}
plt <- ggplot(res_screen, aes(Contaminant, MLE)) + 
  #geom_boxplot() +
  geom_point(aes(color = SL), size = 3, alpha = 0.5) +
  # geom_point(data = sl, aes(Contaminant, Value,
  #                               fill = Threshold, shape = Threshold),
  #                size = 4, alpha = .5) +

  scale_y_log10(labels=scales::comma) +
  
 #scale_shape_manual(values = c(24,25)) +
  scale_color_manual(name = '', values = cbep_colors) +
  ylab('Concentration (ppb)') +
  xlab ('') +
  theme_cbep() +
  #theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1)) 
plt
```
SO, what that shows is that despite DDT being outlawed for a generation, concentrations of DDT residues in Portland Harbor are well above levels of concern.  Simimlarly, PAHs are usually above conservative screaning levels, and many sites had levels of PCBs avove levels of concern.


```{r}
tmp <- res_screen %>%
  mutate(Contaminant = fct_relevel(Contaminant, 'Total PAHs', 'Total PCBs'))
levels(tmp$Contaminant)

tmp_sl <- sl %>%
   mutate(Contaminant = fct_relevel(Contaminant, 'Total PAHs', 'Total PCBs'))
```

```{r fig.width = 6, fig.height=5}
plt <- ggplot(tmp, aes(Contaminant, MLE)) + 
  geom_point(aes(color = SL), size = 4, alpha = 0.5) +
  scale_y_log10(labels=scales::comma) +
  scale_color_manual(name = '', values = cbep_colors) +
  #scale_color_viridis_d(begin=0, end=0.9, name = '') +  # The "end" parameter cuts out a very pale yellow.
  ylab('Concentration (ppb)') +
  xlab ('') +
  theme_cbep() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1)) 
plt
ggsave('Portland Harbor Contaminants.png')
```

```{r fig.width = 5, fig.height=5}
plt + geom_line( aes(as.numeric(Contaminant), MLE, group = SAMPLE_ID), alpha = 0.2)
ggsave('Portland Harbor Contaminants.png')

```


```{r}
levels(factor(res_screen$SAMPLE_ID))
```


